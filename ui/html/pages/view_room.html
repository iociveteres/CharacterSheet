{{define "title"}}{{.Room.Name}}{{end}}
{{define "main"}}
<!-- Server-rendered hidden initial state for Alpine to extract -->
<div id="ssr-data" class="hidden">
    <div id="ssr-current-user" data-user-id="{{.CurrentPlayerView.User.ID}}"
        data-user-name="{{.CurrentPlayerView.User.Name}}" data-user-role="{{.CurrentPlayerView.Role}}"
        data-joined-at="{{humanDate .CurrentPlayerView.JoinedAt .TimeZone}}">
        {{range .CurrentPlayerView.CharacterSheets}}
        <div class="ssr-sheet" data-sheet-id="{{.ID}}" data-name="{{.CharacterName}}"
            data-created="{{humanDate .CreatedAt $.TimeZone}}" data-updated="{{humanDate .UpdatedAt $.TimeZone}}"></div>
        {{end}}
    </div>

    {{range .PlayerViews}}
    <div class="ssr-player" data-user-id="{{.User.ID}}" data-user-name="{{.User.Name}}" data-user-role="{{.Role}}"
        data-joined-at="{{humanDate .JoinedAt $.TimeZone}}">
        {{range .CharacterSheets}}
        <div class="ssr-sheet" data-sheet-id="{{.ID}}" data-name="{{.CharacterName}}"
            data-created="{{humanDate .CreatedAt $.TimeZone}}" data-updated="{{humanDate .UpdatedAt $.TimeZone}}"></div>
        {{end}}
    </div>
    {{end}}

    <div id="ssr-invite-link" data-link="{{.InviteLink}}"></div>
    <div id="ssr-is-elevated" data-value="{{if or (eq .CurrentPlayerView.Role " gamemaster") (eq
        .CurrentPlayerView.Role "moderator" )}}true{{else}}false{{end}}"></div>
    <div id="ssr-is-gamemaster" data-value="{{if eq .CurrentPlayerView.Role " gamemaster"}}true{{else}}false{{end}}">
    </div>
</div>

<div class='room' id="room" data-room-id="{{.Room.ID}}" x-data="roomComponent">
    <div id="character-sheet-container">
        {{if .CharacterSheet}}
        {{template "character_sheet_fragment" .}}
        {{end}}
    </div>

    <div id="right-panel">
        <div class="tabs">
            <!--
            <input class="radiotab" type="radio" id="show-chat" name="toggle" />
            <label class="tablabel" for="show-chat">Chat</label>
            <div id="chat" class="panel chat">
                <div class="scroll-container"></div>
            </div> 
            -->

            <input class="radiotab" type="radio" id="show-characters" name="toggle" checked="checked" />
            <label class="tablabel" for="show-characters">Characters</label>
            <div id="characters" class="panel characters">
                <div class="scroll-container">
                    <button x-on:click="createCharacter" class="button-wide button-large button-colored" type="button">
                        New character
                    </button>

                    <!-- Current User's Characters -->
                    <div class='player' x-bind:data-user-id="$store.room.currentUser.id">
                        <div class="player-name" x-text="$store.room.currentUser.name"></div>
                        <template x-for="sheet in $store.room.currentUser.sheets" x-bind:key="sheet.id">
                            <div class="character-sheet-entry" x-bind:data-sheet-id="sheet.id">
                                <div class="name">
                                    <a x-bind:href="'/sheet/view/' + sheet.id" x-text="sheet.name"></a>
                                </div>
                                <div class="meta created" x-text="'Created ' + sheet.created"></div>
                                <div class="meta updated" x-text="'Modified ' + sheet.updated"></div>
                                <div class="entry-controls">
                                    <button x-on:click="deleteCharacter(sheet.id, sheet.name)" class="delete-entry"
                                        type="button"></button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Other Players' Characters -->
                    <template x-for="player in $store.room.otherPlayers" x-bind:key="player.id">
                        <div class='player' x-bind:data-user-id="player.id">
                            <div class="player-name" x-text="player.name"></div>
                            <template x-for="sheet in player.sheets" x-bind:key="sheet.id">
                                <div class="character-sheet-entry" x-bind:data-sheet-id="sheet.id">
                                    <div class="name">
                                        <a x-bind:href="'/sheet/view/' + sheet.id" x-text="sheet.name"></a>
                                    </div>
                                    <div class="meta created" x-text="'Created ' + sheet.created"></div>
                                    <div class="meta updated" x-text="'Modified ' + sheet.updated"></div>
                                    <div class="entry-controls" x-show="$store.room.isElevated">
                                        <button x-on:click="deleteCharacter(sheet.id, sheet.name)" class="delete-entry"
                                            type="button"></button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <input class="radiotab" type="radio" id="show-players" name="toggle" />
            <label class="tablabel" for="show-players">Players</label>
            <div id="players" class="panel players">
                <div class="scroll-container">
                    <button x-show="$store.room.isGamemaster" x-on:click="openInviteModal"
                        class="button-wide button-large button-colored" type="button">
                        Create invite
                    </button>

                    <!-- Current Player -->
                    <div class='player' id="current-player" x-bind:data-user-id="$store.room.currentUser.id">
                        <div class="player-name" x-text="$store.room.currentUser.name"></div>
                        <div class="meta role" x-text="$store.room.currentUser.role"></div>
                        <div class="meta created" x-text="'Joined at ' + $store.room.currentUser.joinedAt"></div>
                    </div>

                    <!-- Other Players -->
                    <template x-for="player in $store.room.otherPlayers" x-bind:key="player.id">
                        <div class='player' x-bind:data-user-id="player.id">
                            <div class="player-name" x-text="player.name"></div>
                            <template x-if="$store.room.isGamemaster">
                                <select x-on:change="changePlayerRole(player.id, $event.target.value)"
                                    class="role-select" x-model="player.role">
                                    <option value="player">Player</option>
                                    <option value="moderator">Moderator</option>
                                </select>
                            </template>
                            <template x-if="!$store.room.isGamemaster">
                                <div class="meta role" x-text="player.role"></div>
                            </template>
                            <div class="meta created" x-text="'Joined at ' + player.joinedAt"></div>
                            <div class="entry-controls" x-show="$store.room.isGamemaster">
                                <button x-on:click="kickPlayer(player.id, player.name)" class="delete-entry"
                                    type="button"></button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for modals -->
    <div id="overlay" class="overlay"
        x-bind:class="{ 'open': $store.room.modals.invite || $store.room.modals.kicked || $store.room.modals.connectionLost }"
        x-on:click="closeModalOnOverlay"
        x-bind:aria-hidden="!($store.room.modals.invite || $store.room.modals.kicked || $store.room.modals.connectionLost)"
        tabindex="-1">

        <!-- Invite Link Modal -->
        <div x-show="$store.room.modals.invite && $store.room.isElevated" id="invite-link-modal"
            class="modal layout-column" role="dialog" aria-modal="true" x-on:keydown.escape="closeModal">
            <div>
                <div>Active invite link</div>
                <div class="layout-row">
                    <input id="active-invite-link" type="text" readonly aria-label="Invite link"
                        x-model="$store.room.inviteLink" />
                    <button x-on:click="copyInviteLink" class="button-colored"
                        x-bind:class="{ 'copied': inviteLinkCopied }" title="Copy invite link"
                        x-text="inviteLinkCopied ? 'Copied!' : 'Copy'"></button>
                </div>
            </div>

            <div id="new-link-options">
                Or create new one
                <div>
                    <div>
                        <label>Expires in:</label>
                        <select x-model.number="newInvite.expiresInDays">
                            <option value="1">1 day</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="null">Unlimited</option>
                        </select>
                    </div>

                    <div>
                        <label class="label" for="max-uses">Max uses (0 for unlimited):</label>
                        <input x-model.number="newInvite.maxUses" name="max-uses" class="text" type="number"
                            placeholder="0" min="0" max="1000">
                    </div>
                </div>
            </div>

            <div class="actions">
                <button x-on:click="closeModal" class="button-colored" title="Close">Cancel</button>
                <button x-on:click="createNewInviteLink" class="button-colored"
                    title="Create new invite link">Create</button>
            </div>
        </div>

        <!-- Kicked Modal -->
        <div x-show="$store.room.modals.kicked" id="kicked-modal" class="modal layout-column" role="dialog"
            aria-modal="true">
            <div>
                You have been kicked from the room<br>:(
            </div>
            <div class="actions">
                <button x-on:click="closeKickedModal" class="button-colored" title="Close">OK</button>
            </div>
        </div>

        <!-- Connection Lost Modal -->
        <div x-show="$store.room.modals.connectionLost" id="connection-lost-modal" class="modal layout-column"
            role="dialog" aria-modal="true">
            <div>
                Connection to server lost.<br>Please refresh the page.
            </div>
            <div class="actions">
                <button x-on:click="reloadPage" class="button-colored" title="Refresh">Refresh</button>
            </div>
        </div>
    </div>
</div>

<script type="module" src="/static/js/room_ui_alpine.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/@alpinejs/csp@3.x.x/dist/cdn.min.js" defer></script>
<script type="module" src="/static/js/room.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js" defer></script>
<script type="module" src="/static/js/sheet/script.js" defer></script>
<script type="module" src="/static/js/sheet/network.js" defer></script>
{{end}}