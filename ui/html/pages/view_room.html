{{define "title"}}{{.Room.Name}}{{end}}
{{define "main"}}
<!-- Server-rendered hidden initial state for Alpine to extract -->
<div id="ssr-data" class="hidden">
    <div id="ssr-current-user" data-user-id="{{.CurrentPlayerView.User.ID}}"
        data-user-name="{{.CurrentPlayerView.User.Name}}" data-user-role="{{.CurrentPlayerView.Role}}"
        data-joined-at="{{humanDate .CurrentPlayerView.JoinedAt .TimeZone}}">

        <!-- Current user's folders -->
        {{range .CurrentPlayerView.Folders}}
        <div class="ssr-folder" data-folder-id="{{.ID}}" data-name="{{.Name}}" data-visibility="{{.Visibility}}"
            data-sort-order="{{.SortOrder}}"></div>
        {{end}}

        <!-- Current user's sheets -->
        {{range .CurrentPlayerView.CharacterSheets}}
        <div class="ssr-sheet" data-sheet-id="{{.ID}}" data-name="{{.CharacterName}}"
            data-created="{{humanDate .CreatedAt $.TimeZone}}" data-updated="{{humanDate .UpdatedAt $.TimeZone}}"
            data-visibility="{{.Visibility}}" data-folder-id="{{if .FolderID}}{{.FolderID}}{{end}}"></div>
        {{end}}
    </div>

    {{range .PlayerViews}}
    <div class="ssr-player" data-user-id="{{.User.ID}}" data-user-name="{{.User.Name}}" data-user-role="{{.Role}}"
        data-joined-at="{{humanDate .JoinedAt $.TimeZone}}">

        <!-- Player's folders -->
        {{range .Folders}}
        <div class="ssr-folder" data-folder-id="{{.ID}}" data-name="{{.Name}}" data-visibility="{{.Visibility}}"
            data-sort-order="{{.SortOrder}}"></div>
        {{end}}

        <!-- Player's sheets -->
        {{range .CharacterSheets}}
        <div class="ssr-sheet" data-sheet-id="{{.ID}}" data-name="{{.CharacterName}}"
            data-created="{{humanDate .CreatedAt $.TimeZone}}" data-updated="{{humanDate .UpdatedAt $.TimeZone}}"
            data-visibility="{{.Visibility}}" data-folder-id="{{if .FolderID}}{{.FolderID}}{{end}}"></div>
        {{end}}
    </div>
    {{end}}

    <div id="ssr-messages" data-has-more="{{.MessagePage.HasMore}}">
        {{range .MessagePage.Messages}}
        <div class="ssr-message" data-id="{{.Message.ID}}" data-user-id="{{.Message.UserID}}"
            data-user-name="{{.Username}}" data-message="{{.Message.MessageBody}}"
            data-created="{{rfc3339 .Message.CreatedAt}}" {{if
            .Message.CommandResult}}data-command-result="{{.Message.CommandResult}}" {{end}}>
        </div>
        {{end}}
    </div>

    {{range .DicePresets}}
    <div class="ssr-dice-preset" data-slot="{{.SlotNumber}}" data-notation="{{.DiceNotation}}"></div>
    {{end}}

    <div id="ssr-commands" class="hidden">
        {{range .AvailableCommands}}
        <div class="ssr-command" data-command="{{.Command}}" data-description="{{.Description}}"
            data-detailed-description="{{.DetailedDescription}}"></div>
        {{end}}
    </div>

    <div id="ssr-invite-link" data-link="{{.InviteLink}}"></div>
    <div id="ssr-is-elevated" data-value="{{if or (eq .CurrentPlayerView.Role " gamemaster") (eq
        .CurrentPlayerView.Role "moderator" )}}true{{else}}false{{end}}"></div>
    <div id="ssr-is-gamemaster" data-value="{{if eq .CurrentPlayerView.Role " gamemaster"}}true{{else}}false{{end}}">
    </div>
    <div id="ssr-room-id" data-value="{{.Room.ID}}"></div>
</div>

<div class='room' id="room" data-room-id="{{.Room.ID}}" x-data="roomComponent"
    x-bind:class="{ 'panel-hidden': !rightPanelVisible }" x-cloak>
    <div class="links-block"> <a href='{{reverseRev "AccountRooms"}}' title="Back to rooms">&lt;</a></div>
    {{with .Flash}}
    <div class='flash' id="flash-message">{{.}}</div>
    {{end}}

    <div id="character-sheet-container">


        {{if .CharacterSheet}}
        {{template "character_sheet_fragment" .}}
        {{end}}
    </div>

    <div id="right-panel-wrapper">
        <div class="room-controls-container">
            <div class="dice-roller-wrapper" x-cloak>
                <button x-on:click.stop="toggleDiceRoller" class="dice-roller-btn" type="button" title="Dice roller">
                    ⚄
                </button>

                <div x-show="showDiceRoller" x-on:keydown.escape.window="closeDiceRoller" class="dice-popover"
                    x-transition:enter="popover-enter" x-transition:enter-start="popover-enter-start"
                    x-transition:enter-end="popover-enter-end" x-transition:leave="popover-leave"
                    x-transition:leave-start="popover-leave-start" x-transition:leave-end="popover-leave-end">

                    <div class="dice-popover-header">
                        <span>Dice Roller</span>
                        <button x-on:click="closeDiceRoller" class="dice-close-btn" type="button"
                            title="Close">×</button>
                    </div>

                    <div class="roll-against-section">
                        <div class="roll-against-label">Roll against:</div>
                        <div class="roll-against-grid">
                            <template x-for="i in [0, 1, 2, 3]" x-bind:key="i">
                                <div class="roll-against-item">
                                    <input type="number" x-bind:value="rollAgainstInputs[i]"
                                        x-on:input="updateRollAgainstInput(i, $event.target.value)"
                                        class="roll-against-input" min="1" max="999">
                                    <label class="chk-label"> </label>
                                    <input type="checkbox" class="custom" x-bind:checked="selectedRollAgainst === i"
                                        x-on:change="toggleRollAgainst(i)">

                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="dice-modifier-section">
                        <div class="dice-modifier-label">Modifier:</div>
                        <div class="dice-modifier-grid">
                            <!-- First row: negative modifiers -->
                            <div class="dice-modifier-row">
                                <template x-for="n in [-60, -50, -40, -30, -20, -10]" x-bind:key="n">
                                    <label class="dice-radio-label">
                                        <input type="radio" name="dice-modifier" x-bind:value="n"
                                            x-bind:checked="diceModifier === n" x-on:change="updateDiceModifier(n)">
                                        <span x-text="n"></span>
                                    </label>
                                </template>
                            </div>

                            <!-- Second row: zero (centered) -->
                            <div class="dice-modifier-row dice-modifier-zero-row">
                                <label class="dice-radio-label dice-zero-label">
                                    <input type="radio" name="dice-modifier" x-bind:value="0"
                                        x-bind:checked="diceModifier === 0" x-on:change="updateDiceModifier(0)">
                                    <span>0</span>
                                </label>
                            </div>

                            <!-- Third row: positive modifiers -->
                            <div class="dice-modifier-row">
                                <template x-for="n in [10, 20, 30, 40, 50, 60]" x-bind:key="n">
                                    <label class="dice-radio-label">
                                        <input type="radio" name="dice-modifier" x-bind:value="n"
                                            x-bind:checked="diceModifier === n" x-on:change="updateDiceModifier(n)">
                                        <span x-text="'+' + n"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Number of dice slider -->
                    <div class="dice-amount-section">
                        <div class="dice-amount-label">Number of dice:</div>
                        <div class="dice-amount-radio">
                            <template x-for="n in [1, 2, 3, 4, 5]" x-bind:key="n">
                                <label class="dice-radio-label">
                                    <input type="radio" name="dice-amount" x-bind:value="n"
                                        x-bind:checked="diceAmount === n" x-on:change="updateDiceAmount(n)">
                                    <span x-text="n"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- Standard dice buttons -->
                    <div class="standard-dice-section">
                        <button x-on:click="rollStandardDice(5)" class="dice-btn" type="button">d5</button>
                        <button x-on:click="rollStandardDice(10)" class="dice-btn" type="button">d10</button>
                        <button x-on:click="rollStandardDice(20)" class="dice-btn" type="button">d20</button>
                        <button x-on:click="rollStandardDice(100)" class="dice-btn" type="button">d100</button>
                    </div>

                    <!-- Custom dice inputs -->
                    <div class="custom-dice-section">
                        <div class="custom-dice-label">Custom rolls:</div>

                        <!-- First input with placeholder -->
                        <div class="custom-dice-row">
                            <input type="text" x-bind:value="customDice[0]"
                                x-on:input="updateCustomDice(0, $event.target.value)"
                                x-on:keydown.enter="rollCustomDice(0)" placeholder="e.g., 2d10+5"
                                class="custom-dice-input">
                            <button x-on:click="rollCustomDice(0)" class="custom-dice-roll-btn" type="button"
                                x-bind:disabled="isCustomDiceEmpty(0)">
                                Roll
                            </button>
                        </div>

                        <!-- Remaining inputs without placeholder -->
                        <template x-for="i in [1, 2, 3, 4]" x-bind:key="i">
                            <div class="custom-dice-row">
                                <input type="text" x-bind:value="customDice[i]"
                                    x-on:input="updateCustomDice(i, $event.target.value)"
                                    x-on:keydown.enter="rollCustomDice(i)" class="custom-dice-input">
                                <button x-on:click="rollCustomDice(i)" class="custom-dice-roll-btn" type="button"
                                    x-bind:disabled="isCustomDiceEmpty(i)">
                                    Roll
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <button x-on:click="toggleRightPanel" class="toggle-panel-btn" type="button"
                x-bind:title="rightPanelVisible ? 'Hide sidebar' : 'Show sidebar'">
                <span x-text="rightPanelVisible ? '→' : '←'"></span>
            </button>
        </div>
        <div id="right-panel" x-bind:class="{ 'hidden-panel': !rightPanelVisible }">
            <div class="tabs">
                <input class="radiotab" type="radio" id="show-chat" name="toggle" />
                <label class="tablabel" for="show-chat">Chat</label>
                <div id="chat" class="panel chat">
                    <div class="scroll-container">
                        <button x-show="$store.room.chat.hasMore" x-on:click="loadMoreMessages" class="load-more-btn"
                            type="button">
                            Load earlier messages
                        </button>

                        <template x-for="(group, groupIndex) in chatGroupedMessages" x-bind:key="groupIndex">
                            <div class="message-group">
                                <div class="date-separator" x-text="group.dateLabel"></div>
                                <template x-for="(userGroup, userIndex) in groupMessagesByUser(group.messages)"
                                    x-bind:key="userIndex">
                                    <div class="user-message-sequence">
                                        <!-- Sticky username header for this user's message sequence -->
                                        <div class="sticky-author"
                                            x-bind:class="{ 'own-message-header': userGroup.userId === $store.room.currentUser.id }">
                                            <span class="author-name" x-text="userGroup.userName"></span>
                                        </div>

                                        <!-- All messages from this user in sequence -->
                                        <template x-for="msg in userGroup.messages" x-bind:key="msg.id">
                                            <div class="message"
                                                x-bind:class="{ 'own-message': msg.userId === $store.room.currentUser.id }">
                                                <div class="message-body" x-text="msg.messageBody"></div>

                                                <!-- Command result displayed below if present -->
                                                <div x-show="msg.commandResult" class="command-result"
                                                    x-text="msg.commandResult">
                                                </div>

                                                <div class="message-footer">
                                                    <div class="message-time-wrapper">
                                                        <!-- Three-dot menu button -->
                                                        <div x-show="$store.room.isGamemaster"
                                                            class="message-menu-wrapper">
                                                            <button x-on:click.stop="toggleMessageMenu(msg.id)"
                                                                class="message-menu-btn" type="button"
                                                                title="Message actions">
                                                                ⋮
                                                            </button>

                                                            <!-- Message actions popover -->
                                                            <div x-show="messageMenuOpen === msg.id"
                                                                x-on:click.outside="messageMenuOpen = null"
                                                                class="popover message-menu-popover"
                                                                x-transition:enter="popover-enter"
                                                                x-transition:enter-start="popover-enter-start"
                                                                x-transition:enter-end="popover-enter-end"
                                                                x-transition:leave="popover-leave"
                                                                x-transition:leave-start="popover-leave-start"
                                                                x-transition:leave-end="popover-leave-end">
                                                                <div class="popover-item"
                                                                    x-on:click="deleteMessage(msg.id)">
                                                                    Delete message
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="message-time" x-text="msg.timeLabel"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <div x-ref="chatBottom"></div>

                        <div x-show="showNewMessagesButton" x-on:click="scrollToNewMessages" class="new-messages-button"
                            x-transition:enter="new-msg-enter" x-transition:enter-start="new-msg-enter-start"
                            x-transition:enter-end="new-msg-enter-end" x-transition:leave="new-msg-leave"
                            x-transition:leave-start="new-msg-leave-start" x-transition:leave-end="new-msg-leave-end">
                            <span
                                x-text="unreadMessageCount === 1 ? '1 new message' : unreadMessageCount + ' new messages'"></span>
                            <span class="arrow-down">↓</span>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <textarea x-model="chatInput" x-on:keydown="handleChatKeydown($event)"
                            x-on:input="handleChatInput($event)" x-ref="chatTextarea" placeholder="Type a message..."
                            rows="3" maxlength="2000"></textarea>

                        <div class="layout-column">
                            <div class="commands-popover-wrapper">
                                <button x-on:click.stop="toggleCommandsPopover"
                                    class="button-colored button-wide commands-btn" type="button"
                                    title="Available commands">
                                    /
                                </button>

                                <div x-show="showCommandsPopover" x-on:click.outside="showCommandsPopover = false"
                                    class="commands-popover" x-transition:enter="popover-enter"
                                    x-transition:enter-start="popover-enter-start"
                                    x-transition:enter-end="popover-enter-end" x-transition:leave="popover-leave"
                                    x-transition:leave-start="popover-leave-start"
                                    x-transition:leave-end="popover-leave-end">
                                    <div class="commands-popover-header">Available Commands</div>
                                    <div class="commands-list">
                                        <template x-for="cmd in availableCommands" x-bind:key="cmd.command">
                                            <div class="command-entry" x-on:click="insertCommand(cmd.command)"
                                                x-bind:title="cmd.detailedDescription">
                                                <code class="command-name" x-text="cmd.command"></code>
                                                <span class="command-description" x-text="cmd.description"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <button x-on:click="sendChatMessage" class="button-colored button-wide send-btn"
                                x-bind:disabled="!chatInput.trim()" type="button">
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <input class="radiotab" type="radio" id="show-characters" name="toggle" checked="checked" />
                <label class="tablabel" for="show-characters">Characters</label>
                <div id="characters" class="panel characters">
                    <div class="scroll-container">
                        <div class="layout-row">
                            <button x-on:click="createCharacter" class="button-wide button-large button-colored"
                                type="button">
                                New character
                            </button>
                            <button x-on:click="openImportModal" class="button-large button-colored import-button"
                                type="button" title="Import character">
                                ↑
                            </button>
                        </div>
                        <!-- Add Folder Button -->
                        <button x-on:click="createFolder" class="button-wide button-colored create-folder-btn"
                            type="button">
                            Add Folder
                        </button>

                        <!-- Current User's Characters and Folders -->
                        <div class='player' x-bind:data-user-id="$store.room.currentUser.id">
                            <!-- Player Header with Collapse Toggle -->
                            <div class="player-header"
                                x-bind:class="{ 'collapsed': isPlayerCollapsed($store.room.currentUser.id) }">
                                <div class="player-name" x-text="$store.room.currentUser.name"></div>
                                <button x-on:click="togglePlayerCollapse($store.room.currentUser.id)"
                                    class="player-collapse-btn" type="button"
                                    x-bind:title="isPlayerCollapsed($store.room.currentUser.id) ? 'Expand' : 'Collapse'">
                                </button>
                            </div>

                            <div class="player-collapsible-content">
                                <!-- Folders -->
                                <div class="folders-container sortable-folders">
                                    <template x-for="folder in $store.room.currentUser.folders" x-bind:key="folder.id">
                                        <div class="folder" x-bind:data-folder-id="folder.id">
                                            <div class="folder-header"
                                                x-bind:class="{ 'collapsed': isFolderCollapsed(folder.id) }">
                                                <input type="text" class="folder-name-input" x-bind:value="folder.name"
                                                    x-on:input="debouncedUpdateFolderName(folder.id, $event.target.value)"
                                                    placeholder="Folder name" />
                                                <div class="folder-controls">
                                                    <button x-on:click="toggleFolderCollapse(folder.id)"
                                                        class="folder-collapse-btn" type="button"
                                                        x-bind:title="isFolderCollapsed(folder.id) ? 'Expand' : 'Collapse'">
                                                    </button>
                                                    <div class="folder-drag-handle" title="Drag to reorder"></div>
                                                </div>
                                            </div>

                                            <div class="folder-content">
                                                <div class="folder-visibility">
                                                    <select x-bind:value="folder.visibility"
                                                        x-on:change="changeFolderVisibility(folder.id, $event.target.value)"
                                                        title="Folder Access">
                                                        <option value="everyone_can_edit">Everyone can edit</option>
                                                        <option value="everyone_can_view">Everyone can view</option>
                                                        <option value="everyone_can_see">Everyone can see</option>
                                                        <option value="hide_from_players">Hide from players</option>
                                                    </select>
                                                    <button x-on:click="deleteFolder(folder.id, folder.name)"
                                                        class="folder-delete-btn" type="button" title="Delete folder">×
                                                    </button>
                                                </div>

                                                <!-- Sheets in folder -->
                                                <div class="folder-sheets sortable-sheets"
                                                    x-bind:data-folder-id="folder.id">
                                                    <template
                                                        x-for="sheet in getFolderSheets($store.room.currentUser, folder.id)"
                                                        x-bind:key="sheet.id">
                                                        <div class="character-sheet-entry"
                                                            x-bind:data-sheet-id="sheet.id">

                                                            <div class="sheet-content">
                                                                <div class="name">
                                                                    <a x-bind:href="'/sheet/view/' + sheet.id"
                                                                        x-text="sheet.name || '_____'"></a>
                                                                    <div class="sheet-drag-handle" title="Drag to move">
                                                                    </div>
                                                                </div>
                                                                <div class="meta created"
                                                                    x-text="'Created ' + sheet.created"></div>
                                                                <div class="meta updated"
                                                                    x-text="'Modified ' + sheet.updated"></div>
                                                                <div class="entry-controls">
                                                                    <div class="control-buttons"></div>
                                                                    <div class="control-buttons">
                                                                        <button
                                                                            x-on:click="exportCharacter(sheet.id, sheet.name)"
                                                                            class="export-entry" type="button"
                                                                            title="Export character"></button>
                                                                        <button
                                                                            x-on:click="deleteCharacter(sheet.id, sheet.name)"
                                                                            class="delete-entry" type="button"
                                                                            title="Delete character"></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Default Area -->
                                <div class="default-area sortable-sheets"
                                    x-bind:data-player-id="$store.room.currentUser.id" data-folder-id="null">
                                    <template x-for="sheet in getDefaultAreaSheets($store.room.currentUser)"
                                        x-bind:key="sheet.id">
                                        <div class="character-sheet-entry" x-bind:data-sheet-id="sheet.id">

                                            <div class="sheet-content">
                                                <div class="name">
                                                    <a x-bind:href="'/sheet/view/' + sheet.id"
                                                        x-text="sheet.name || '_____'"></a>
                                                    <div class="sheet-drag-handle" title="Drag to move"></div>
                                                </div>
                                                <div class="meta created" x-text="'Created ' + sheet.created"></div>
                                                <div class="meta updated" x-text="'Modified ' + sheet.updated"></div>
                                                <div class="entry-controls">
                                                    <div class="control-buttons">
                                                        <select x-bind:value="sheet.visibility"
                                                            x-on:change="changeSheetVisibility(sheet.id, $event.target.value)"
                                                            title="Access">
                                                            <option value="everyone_can_edit">Everyone can edit</option>
                                                            <option value="everyone_can_view">Everyone can view</option>
                                                            <option value="everyone_can_see">Everyone can see</option>
                                                            <option value="hide_from_players">Hide from players</option>
                                                        </select>
                                                    </div>
                                                    <div class="control-buttons">
                                                        <button x-on:click="exportCharacter(sheet.id, sheet.name)"
                                                            class="export-entry" type="button"
                                                            title="Export character"></button>
                                                        <button x-on:click="deleteCharacter(sheet.id, sheet.name)"
                                                            class="delete-entry" type="button"
                                                            title="Delete character"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Other Players' Characters and Folders -->
                        <template x-for="player in $store.room.otherPlayers" x-bind:key="player.id">
                            <div class='player' x-bind:data-user-id="player.id">
                                <!-- Player Header with Collapse Toggle -->
                                <div class="player-header" x-bind:class="{ 'collapsed': isPlayerCollapsed(player.id) }">
                                    <div class="player-name" x-text="player.name"></div>
                                    <button x-on:click="togglePlayerCollapse(player.id)" class="player-collapse-btn"
                                        type="button"
                                        x-bind:title="isPlayerCollapsed(player.id) ? 'Expand' : 'Collapse'">
                                    </button>
                                </div>

                                <div class="player-collapsible-content">
                                    <!-- Folders -->
                                    <div class="folders-container">
                                        <template x-for="folder in getVisibleFolders(player)" x-bind:key="folder.id">
                                            <div class="folder" x-bind:data-folder-id="folder.id">
                                                <div class="folder-header"
                                                    x-bind:class="{ 'collapsed': isFolderCollapsed(folder.id) }">
                                                    <span class="folder-name-display" x-text="folder.name"></span>
                                                    <div class="folder-controls">
                                                        <button x-on:click="toggleFolderCollapse(folder.id)"
                                                            class="folder-collapse-btn" type="button"
                                                            x-bind:title="isFolderCollapsed(folder.id) ? 'Expand' : 'Collapse'">
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="folder-content">
                                                    <template x-for="sheet in getFolderSheets(player, folder.id)"
                                                        x-bind:key="sheet.id">
                                                        <div class="character-sheet-entry"
                                                            x-bind:data-sheet-id="sheet.id">
                                                            <div class="sheet-content">
                                                                <div class="name">
                                                                    <template
                                                                        x-if="$store.room.canOpenSheet(sheet, player.id)">
                                                                        <a x-bind:href="'/sheet/view/' + sheet.id"
                                                                            x-text="sheet.name"></a>
                                                                    </template>
                                                                    <template
                                                                        x-if="!$store.room.canOpenSheet(sheet, player.id)">
                                                                        <span x-text="sheet.name"></span>
                                                                    </template>
                                                                </div>
                                                                <div class="meta created"
                                                                    x-text="'Created ' + sheet.created"></div>
                                                                <div class="meta updated"
                                                                    x-text="'Modified ' + sheet.updated"></div>
                                                                <div class="entry-controls">
                                                                    <div class="control-buttons"></div>
                                                                    <div class="control-buttons">
                                                                        <button
                                                                            x-on:click="exportCharacter(sheet.id, sheet.name)"
                                                                            class="export-entry" type="button"
                                                                            title="Export character"></button>
                                                                        <template x-if="$store.room.isElevated">
                                                                            <button
                                                                                x-on:click="deleteCharacter(sheet.id, sheet.name)"
                                                                                class="delete-entry" type="button"
                                                                                title="Delete character"></button>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Default Area -->
                                    <div class="default-area" x-bind:data-player-id="player.id">
                                        <template x-for="sheet in getDefaultAreaSheets(player)" x-bind:key="sheet.id">
                                            <div class="character-sheet-entry" x-bind:data-sheet-id="sheet.id">
                                                <div class="sheet-content">
                                                    <div class="name">
                                                        <template x-if="$store.room.canOpenSheet(sheet, player.id)">
                                                            <a x-bind:href="'/sheet/view/' + sheet.id"
                                                                x-text="sheet.name"></a>
                                                        </template>
                                                        <template x-if="!$store.room.canOpenSheet(sheet, player.id)">
                                                            <span x-text="sheet.name"></span>
                                                        </template>
                                                    </div>
                                                    <div class="meta created" x-text="'Created ' + sheet.created"></div>
                                                    <div class="meta updated" x-text="'Modified ' + sheet.updated">
                                                    </div>
                                                    <div class="entry-controls">
                                                        <div class="control-buttons"></div>
                                                        <div class="control-buttons">
                                                            <button x-on:click="exportCharacter(sheet.id, sheet.name)"
                                                                class="export-entry" type="button"
                                                                title="Export character"></button>
                                                            <template x-if="$store.room.isElevated">
                                                                <button
                                                                    x-on:click="deleteCharacter(sheet.id, sheet.name)"
                                                                    class="delete-entry" type="button"
                                                                    title="Delete character"></button>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <input class="radiotab" type="radio" id="show-players" name="toggle" />
                <label class="tablabel" for="show-players">Players</label>
                <div id="players" class="panel players">
                    <div class="scroll-container">
                        <button x-show="$store.room.isGamemaster" x-on:click="openInviteModal"
                            class="button-wide button-large button-colored" type="button">
                            Create invite
                        </button>

                        <!-- Current Player -->
                        <div class='player' id="current-player" x-bind:data-user-id="$store.room.currentUser.id">
                            <div class="player-name" x-text="$store.room.currentUser.name"></div>
                            <div class="meta role" x-text="$store.room.currentUser.role"></div>
                            <div class="meta created" x-text="'Joined at ' + $store.room.currentUser.joinedAt"></div>
                        </div>

                        <!-- Other Players -->
                        <template x-for="player in $store.room.otherPlayers" x-bind:key="player.id">
                            <div class='player' x-bind:data-user-id="player.id">
                                <div class="player-name" x-text="player.name"></div>
                                <template x-if="$store.room.isGamemaster">
                                    <select x-on:change="changePlayerRole(player.id, $event.target.value)"
                                        class="role-select" x-model="player.role">
                                        <option value="player">Player</option>
                                        <option value="moderator">Moderator</option>
                                    </select>
                                </template>
                                <template x-if="!$store.room.isGamemaster">
                                    <div class="meta role" x-text="player.role"></div>
                                </template>
                                <div class="meta created" x-text="'Joined at ' + player.joinedAt"></div>
                                <div class="control-buttons" x-show="$store.room.isGamemaster">
                                    <button x-on:click="kickPlayer(player.id, player.name)" class="delete-entry"
                                        type="button"></button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for modals -->
    <div id="overlay" class="overlay"
        x-bind:class="{ 'open': $store.room.modals.invite || $store.room.modals.kicked || $store.room.modals.connectionLost || $store.room.modals.import || $store.room.modals.confirm }"
        x-on:click="closeModalOnOverlay"
        x-bind:aria-hidden="!($store.room.modals.invite || $store.room.modals.kicked || $store.room.modals.connectionLost || $store.room.modals.import || $store.room.modals.confirm)"
        tabindex="-1">

        <!-- Custom confirm -->
        <div x-show="$store.room.modals.confirm" id="confirm-modal" class="modal layout-column" role="dialog"
            aria-modal="true" x-on:keydown.escape.window="$store.room.modals.confirm && confirmCancel()"
            x-on:keydown.enter.window.prevent="$store.room.modals.confirm && confirmOk()">
            <div x-text="$store.room.confirmModal.message" class="confirm-text"></div>
            <div class="actions">
                <button x-on:click="confirmCancel()" class="button-colored" type="button" title="Cancel">
                    Cancel
                </button>
                <button x-on:click="confirmOk()" class="button-colored" type="button" title="Confirm"
                    x-ref="confirmOkBtn">
                    OK
                </button>
            </div>
        </div>

        <!-- Invite Link Modal -->
        <div x-show="$store.room.modals.invite && $store.room.isElevated" id="invite-link-modal"
            class="modal layout-column" role="dialog" aria-modal="true" x-on:keydown.escape="closeModal">
            <div>
                <div>Active invite link</div>
                <div class="layout-row">
                    <input id="active-invite-link" type="text" readonly aria-label="Invite link"
                        x-model="$store.room.inviteLink" />
                    <button x-on:click="copyInviteLink" class="button-colored"
                        x-bind:class="{ 'copied': inviteLinkCopied }" title="Copy invite link"
                        x-text="inviteLinkCopied ? 'Copied!' : 'Copy'"></button>
                </div>
            </div>

            <div id="new-link-options">
                Or create new one
                <div>
                    <div>
                        <label>Expires in:</label>
                        <select x-model.number="newInvite.expiresInDays">
                            <option value="1">1 day</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="null">Unlimited</option>
                        </select>
                    </div>

                    <div>
                        <label class="label" for="max-uses">Max uses (0 for unlimited):</label>
                        <input x-model.number="newInvite.maxUses" name="max-uses" class="text" type="number"
                            placeholder="0" min="0" max="1000">
                    </div>
                </div>
            </div>

            <div class="actions">
                <button x-on:click="closeModal" class="button-colored" title="Close">Cancel</button>
                <button x-on:click="createNewInviteLink" class="button-colored"
                    title="Create new invite link">Create</button>
            </div>
        </div>

        <!-- Import Modal -->
        <div x-show="$store.room.modals.import" id="import-modal" class="modal layout-column" role="dialog"
            aria-modal="true" x-on:keydown.escape="closeModal">
            <h3>Import Character</h3>
            <form x-ref="importForm" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}" />
                <input type="hidden" name="room_id" x-bind:value="$store.room.roomId" />
                <div class="layout-column">
                    <label for="sheet-file">Select JSON file:</label>
                    <input type="file" id="sheet-file" name="sheet_file" accept=".json" required />
                </div>
            </form>

            <div class="actions">
                <button x-on:click="closeModal" class="button-colored" title="Close">Cancel</button>
                <button x-on:click="submitImport" class="button-colored" title="Import character">Import</button>
            </div>
        </div>

        <!-- Kicked Modal -->
        <div x-show="$store.room.modals.kicked" id="kicked-modal" class="modal layout-column" role="dialog"
            aria-modal="true">
            <div>
                You have been kicked from the room<br>:(
            </div>
            <div class="actions">
                <button x-on:click="closeKickedModal" class="button-colored" title="Close">OK</button>
            </div>
        </div>

        <!-- Connection Lost Modal -->
        <div x-show="$store.room.modals.connectionLost" id="connection-lost-modal" class="modal layout-column"
            role="dialog" aria-modal="true">
            <div>
                Connection to server lost.<br>Please refresh the page.
            </div>
            <div class="actions">
                <button x-on:click="reloadPage" class="button-colored" title="Refresh">Refresh</button>
            </div>
        </div>
    </div>
</div>

<script type="importmap" nonce="{{.Nonce}}" defer>
{{importMapJSON}}
</script>
<script type="module" src='/static/js/room_ui_alpine.js?v={{version "js/room_ui_alpine.js"}}' defer></script>
<script src="https://cdn.jsdelivr.net/npm/@alpinejs/csp@3.x.x/dist/cdn.min.js" defer></script>
<script type="module" src='/static/js/room.js?v={{version "js/room.js"}}' defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js" defer></script>
<script type="module" src='/static/js/sheet/script.js?v={{version "js/sheet/script.js"}}' defer></script>
{{end}}